name: Sync Azure DevOps Work Items to Chroma

on:
  # Allow manual trigger only for testing
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  sync-ado:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::581351078906:role/GitHubActionsS3Access
          aws-region: us-east-1

      - name: Download Chroma directory from S3
        run: |
          mkdir -p chroma
          aws s3 sync s3://preludetx-strinh/chroma ./chroma
          ls -R chroma

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests
          pip install beautifulsoup4
      
      - name: Get latest modified date from Chroma
        id: getdate
        run: |
          python get_last_date.py
          FILTERED_DATE=$(cat filtered_date.txt)
          echo "FILTERED_DATE=$FILTERED_DATE" >> $GITHUB_ENV
        env:
          CHROMA_DIR: ./chroma
          DATE_FILE: filtered_date.txt

      - name: Fetch ADO Work Items using python
        run: python update_embeddings.py
        env:
          AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
          AZURE_DEVOPS_PROJECT: ${{ secrets.AZURE_DEVOPS_PROJECT }}
          AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
          FILTERED_DATE: ${{ env.FILTERED_DATE }}
      
      - name: Upload exported raw JSON to records
        uses: actions/upload-artifact@v4
        with:
          name: workitems-export
          path: workitems_export_*.json
          retention-days: 2
      
      - name: Find exported JSON filename
        id: findfile
        run: |
          FILE=$(ls workitems_export_*.json | sort | tail -n 1)
          echo "WORKITEMS_FILE=$FILE" >> $GITHUB_ENV
          echo "Found file: $FILE"

      - name: Clean and chunk text for embeddings
        run: |
          python clean_workitems.py
          CLEAN_FILE="${WORKITEMS_FILE%.*}_cleaned.json"
          echo "CLEANED_FILE=$CLEAN_FILE" >> $GITHUB_ENV
          echo "Generated cleaned file: $CLEAN_FILE"
        env:
          INPUT_FILE: ${{ env.WORKITEMS_FILE }}

      - name: Upload exported cleaned JSON to records
        uses: actions/upload-artifact@v4
        with:
          name: workitems-export-cleaned
          path: workitems_export_*_cleaned.json
          retention-days: 2

      - name: Start Chroma container and update embeddings
        run: |
         echo "Launching Python container with Chroma data mounted..."
         docker run --rm \
           -v ${{ github.workspace }}/chroma:/chroma \
           -v ${{ github.workspace }}:/app \
           -w /app \
           -e INPUT_FILE=${{ env.CLEANED_FILE }} \
           python:3.11-slim \
           bash -c "pip install --no-cache-dir chromadb && python upload_chromadb.py"

      - name: Upload updated Chroma directory to S3
        run: |
          echo "Uploading updated ChromaDB directory back to S3..."
          aws s3 sync ./chroma s3://preludetx-string/chroma --delete
          echo "âœ… Upload complete."
